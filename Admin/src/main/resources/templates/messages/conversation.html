<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Messagerie - Discussion</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<body class="chat-bg">
<div th:replace="~{fragments/navbar :: sidebar}"></div>
<div class="chat-container">
    <div class="chat-header">
        <div class="chat-header-avatar">
            <span th:text="${employee != null ? employee.prenom?.substring(0,1) : (employeeSnapshot != null ? employeeSnapshot.prenom?.substring(0,1) : 'U')}"></span>
        </div>
        <div class="chat-header-info">
            <div class="chat-header-title">
                <span th:text="${employee != null ? employee.nom : (employeeSnapshot != null ? employeeSnapshot.nom : 'Employé inconnu')}"></span>
                <span th:text="${employee != null ? employee.prenom : (employeeSnapshot != null ? employeeSnapshot.prenom : '')}"></span>
            </div>
            <div class="chat-header-meta">
                <span th:text="'Location : ' + (${employee != null ? employee.locationId : (employeeSnapshot != null ? employeeSnapshot.locationId : '')})"></span>
                <span> | </span>
                <span th:text="'Département : ' + (${employee != null ? employee.departementId : (employeeSnapshot != null ? employeeSnapshot.departementId : '')})"></span>
            </div>
        </div>
    </div>
    <div class="chat-messages" id="chat-messages">
        <div th:each="msg : ${messages}" th:classappend="${msg.sender_id == adminId} ? 'chat-bubble chat-bubble-admin' : 'chat-bubble chat-bubble-employee'">
            <div class="chat-bubble-row">
                <div th:if="${msg.sender_id != adminId}" class="chat-bubble-avatar">
                    <span th:text="${employee != null ? employee.prenom?.substring(0,1) : (employeeSnapshot != null ? employeeSnapshot.prenom?.substring(0,1) : 'U')}"></span>
                </div>
                <div class="chat-bubble-content">
                    <div class="chat-bubble-text" th:text="${msg.content}"></div>
                    <div class="chat-bubble-date" th:text="${#dates.format(msg.timestamp, 'dd/MM/yyyy HH:mm')}"></div>
                </div>
                <div th:if="${msg.sender_id == adminId}" class="chat-bubble-avatar chat-bubble-avatar-admin">
                    <span>A</span>
                </div>
            </div>
        </div>
    </div>
    <form th:action="@{'/messages/' + ${employee != null ? employee.id : (employeeSnapshot != null ? employeeSnapshot.id : '')}}" method="post" class="chat-input-form">
        <input type="text" name="content" placeholder="Votre message..." required autocomplete="off" class="chat-input" />
        <button type="submit" class="chat-send-btn">Envoyer</button>
    </form>
</div>
<script>
// Scroll to bottom on load
window.onload = function() {
  var el = document.getElementById('chat-messages');
  if (el) el.scrollTop = el.scrollHeight;
}
</script>
</body>
</html>
